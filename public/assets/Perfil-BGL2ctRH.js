import{_ as Z,y as H,a as J,r as u,s as K,W as w,X as k,B as l,A as n,Y as t,Z as j,$ as x,a0 as D,z as N,a1 as R,C as v,a2 as O,a3 as C,a4 as aa,v as q,a5 as ea,a6 as oa,a7 as ra,a8 as la,a9 as ta,aa as sa,ab as ia,R as na,S as g,U as S}from"./index-DQ_n0XMR.js";const ua={class:"row justify-center"},ca={class:"col-12 col-md-8 col-lg-6"},da={class:"row justify-center q-mb-lg"},ma={class:"column items-center"},va=["src"],ga=["src"],pa=["src"],fa={class:"q-mt-md q-gutter-sm"},ba={class:"row justify-end q-mt-md"},ya={class:"row q-col-gutter-md justify-center"},_a=["src","alt"],ha={class:"text-caption q-mt-xs"},wa={__name:"Perfil",setup(Pa){const i=na(),c=H(),r=J(()=>c.usuario),p=u(""),f=u(""),E=u(""),b=u(""),V=u(""),U=u(!1),y=u(!1),z=u(!1),m=u(""),_=u(null),$=[{id:"avatar1",nombre:"Casual"},{id:"avatar2",nombre:"Profesional"},{id:"avatar3",nombre:"Deportivo"},{id:"avatar4",nombre:"Elegante"},{id:"avatar5",nombre:"Creativo"}];K(async()=>{if(console.log("🔄 Perfil mounted - Usuario inicial:",r.value),r.value){console.log("👤 Datos del usuario:",{nombre:r.value.nombre,email:r.value.email,imagenPerfil:r.value.imagenPerfil,avatarPredeterminado:r.value.avatarPredeterminado}),p.value=r.value.nombre||"",f.value=r.value.email||"",m.value=r.value.avatarPredeterminado||"avatar1";try{const a=await w.get(`/api/usuarios/${r.value._id}`);a.data&&(console.log("📥 Datos del backend:",a.data),c.setUser(a.data),p.value=a.data.nombre||"",f.value=a.data.email||"",m.value=a.data.avatarPredeterminado||"avatar1",console.log("🔄 Usuario actualizado:",c.usuario))}catch(a){console.warn("No se pudieron cargar los datos actualizados del usuario:",a)}}});const P=a=>{const e=`/avatars/${a}.svg`;return console.log("🎭 getAvatarUrl:",{avatarId:a,url:e}),e},A=a=>(console.log("🖼️ getImagenPerfilUrl input:",a?a.substring(0,50)+"...":"null"),a?a.startsWith("data:")?(console.log("✅ Imagen base64 detectada"),a):a.startsWith("http")?(console.log("✅ URL externa detectada"),a):(console.log("⚠️ Ruta legacy detectada, puede no funcionar en producción"),`https://proyectofinal-g4vh.onrender.com${a}`):(console.log("🖼️ No hay imagen de perfil"),null)),B=a=>{var e;console.warn("❌ Error al cargar imagen, usando avatar"),a.target.src=P(((e=r.value)==null?void 0:e.avatarPredeterminado)||"avatar1")},L=a=>{console.warn("Error al cargar avatar, usando avatar1 por defecto"),a.target.src=P("avatar1")},M=async()=>{try{console.log("🔧 Reparando imagen rota manualmente..."),await w.delete("/api/usuarios/eliminar-imagen"),console.log("✅ Imagen rota eliminada del backend");const a={...r.value};delete a.imagenPerfil,a.avatarPredeterminado||(a.avatarPredeterminado="avatar1"),c.setUser(a),i.notify({color:"positive",message:"Imagen reparada correctamente",icon:"check"})}catch(a){console.error("Error al reparar imagen:",a),i.notify({color:"negative",message:"Error al reparar imagen",icon:"error"})}},T=()=>{var a;m.value=((a=r.value)==null?void 0:a.avatarPredeterminado)||"avatar1",z.value=!0},W=()=>{var a;(a=_.value)==null||a.click()},F=async a=>{var s,h;const e=a.target.files[0];if(e){if(!e.type.startsWith("image/")){i.notify({color:"negative",message:"Por favor selecciona un archivo de imagen válido",icon:"error"});return}if(e.size>5*1024*1024){i.notify({color:"negative",message:"La imagen debe ser menor a 5MB",icon:"error"});return}try{y.value=!0,console.log("📤 Subiendo imagen al backend...");const o=new FormData;o.append("imagen",e);const d=await w.post("/api/usuarios/subir-imagen",o,{headers:{"Content-Type":"multipart/form-data"}});console.log("📥 Respuesta del backend:",d.data),d.data&&d.data.usuario&&(console.log("✅ Imagen subida exitosamente:",d.data.usuario.imagenPerfil),console.log("🔄 Datos del usuario después de subir:",d.data.usuario),c.setUser(d.data.usuario),console.log("🔄 Usuario en store después de actualizar:",c.usuario),i.notify({color:"positive",message:"Imagen de perfil actualizada correctamente",icon:"check"}),_.value&&(_.value.value=""),setTimeout(()=>{var I,Q;console.log("🔍 Verificando usuario final:",r.value),console.log("🖼️ ¿Tiene imagen?",!!((I=r.value)!=null&&I.imagenPerfil)),console.log("🎭 ¿Tiene avatar?",!!((Q=r.value)!=null&&Q.avatarPredeterminado))},1e3))}catch(o){console.error("❌ Error al subir imagen:",o),i.notify({color:"negative",message:"Error al subir la imagen: "+(((h=(s=o.response)==null?void 0:s.data)==null?void 0:h.mensaje)||o.message),icon:"error"})}finally{y.value=!1,_.value&&(_.value.value="")}}},G=async()=>{try{const a=await w.delete("/api/usuarios/eliminar-imagen");a.data&&a.data.usuario&&(c.setUser(a.data.usuario),i.notify({color:"positive",message:"Imagen de perfil eliminada correctamente",icon:"check"}))}catch(a){console.error("Error al eliminar imagen:",a),i.notify({color:"negative",message:"Error al eliminar la imagen",icon:"error"})}},X=async()=>{if(m.value)try{const a=await w.put("/api/usuarios/avatar",{avatarPredeterminado:m.value});a.data&&a.data.usuario&&(c.setUser(a.data.usuario),z.value=!1,i.notify({color:"positive",message:"Avatar actualizado correctamente",icon:"check"}),console.log("Avatar actualizado en el backend:",a.data.usuario.avatarPredeterminado))}catch(a){console.error("Error al actualizar avatar:",a),i.notify({color:"negative",message:"Error al actualizar el avatar",icon:"error"})}},Y=async()=>{try{if(U.value=!0,!p.value.trim()||!f.value.trim()){i.notify({color:"negative",message:"Por favor completa todos los campos requeridos",icon:"error"});return}const a=await w.put("/api/usuarios/actualizar",{_id:r.value._id,nombre:p.value.trim(),email:f.value.trim()});a.data&&a.data.usuario&&(c.setUser(a.data.usuario),i.notify({message:"Perfil actualizado correctamente",color:"positive",icon:"check_circle"}),console.log("Perfil actualizado en el backend:",a.data.usuario)),E.value="",b.value="",V.value=""}catch(a){console.error("Error al actualizar perfil:",a),i.notify({message:"Error al actualizar el perfil",color:"negative",icon:"error"})}finally{U.value=!1}};return(a,e)=>(g(),k("div",null,[l(aa,{padding:""},{default:n(()=>[t("div",ua,[t("div",ca,[l(j,{class:"q-pa-lg"},{default:n(()=>[l(x,null,{default:n(()=>{var s,h;return[e[8]||(e[8]=t("div",{class:"text-h5 q-mb-md"},"Mi Perfil",-1)),t("div",da,[t("div",ma,[l(D,{size:"150px",class:"q-mb-sm bg-grey-3"},{default:n(()=>{var o,d;return[(o=r.value)!=null&&o.imagenPerfil?(g(),k("img",{key:0,src:A(r.value.imagenPerfil),style:{width:"100%",height:"100%","object-fit":"cover","border-radius":"50%"},onError:B,onLoad:e[0]||(e[0]=I=>console.log("✅ Imagen cargada correctamente:",A(r.value.imagenPerfil)))},null,40,va)):(d=r.value)!=null&&d.avatarPredeterminado?(g(),k("img",{key:1,src:P(r.value.avatarPredeterminado),style:{width:"100%",height:"100%","object-fit":"cover"},onError:L},null,40,ga)):(g(),k("img",{key:2,src:P("avatar1"),style:{width:"100%",height:"100%","object-fit":"cover"}},null,8,pa))]}),_:1}),t("div",fa,[l(v,{color:"primary",label:"Avatares",size:"md",onClick:T,icon:"face"}),l(v,{color:"secondary",label:y.value?"Subiendo...":"Subir Imagen",size:"md",onClick:W,icon:y.value?"cloud_upload":"photo_camera",loading:y.value,disable:y.value},null,8,["label","icon","loading","disable"]),(s=r.value)!=null&&s.imagenPerfil?(g(),N(v,{key:0,color:"negative",label:"Eliminar",size:"sm",onClick:G,icon:"delete",flat:""})):R("",!0),(h=r.value)!=null&&h.imagenPerfil?(g(),N(v,{key:1,color:"orange",label:"Reparar",size:"sm",onClick:M,icon:"build",flat:""})):R("",!0)]),t("input",{ref_key:"fileInput",ref:_,type:"file",accept:"image/*",style:{display:"none"},onChange:F},null,544)])]),l(O,{onSubmit:Y,class:"q-gutter-md"},{default:n(()=>[l(C,{modelValue:p.value,"onUpdate:modelValue":e[1]||(e[1]=o=>p.value=o),label:"Nombre completo",outlined:"",rules:[o=>!!o||"El nombre es obligatorio"]},null,8,["modelValue","rules"]),l(C,{modelValue:f.value,"onUpdate:modelValue":e[2]||(e[2]=o=>f.value=o),label:"Correo electrónico",outlined:"",type:"email",rules:[o=>!!o||"El correo es obligatorio",o=>/^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$/.test(o)||"Correo inválido"]},null,8,["modelValue","rules"]),e[7]||(e[7]=t("div",{class:"text-subtitle1 q-mt-lg"},"Cambiar contraseña",-1)),l(C,{modelValue:E.value,"onUpdate:modelValue":e[3]||(e[3]=o=>E.value=o),label:"Contraseña actual",outlined:"",type:"password",rules:[o=>!o||b.value.length>0&&!!o||"Requerida para cambiar contraseña"]},null,8,["modelValue","rules"]),l(C,{modelValue:b.value,"onUpdate:modelValue":e[4]||(e[4]=o=>b.value=o),label:"Nueva contraseña",outlined:"",type:"password",rules:[o=>!o||o.length>=6||"Mínimo 6 caracteres"]},null,8,["modelValue","rules"]),l(C,{modelValue:V.value,"onUpdate:modelValue":e[5]||(e[5]=o=>V.value=o),label:"Confirmar contraseña",outlined:"",type:"password",rules:[o=>!b.value.length||o===b.value||"Las contraseñas no coinciden"]},null,8,["modelValue","rules"]),t("div",ba,[l(v,{type:"submit",color:"primary",label:"Guardar cambios",loading:U.value},null,8,["loading"])])]),_:1})]}),_:1})]),_:1})])])]),_:1}),l(ia,{modelValue:z.value,"onUpdate:modelValue":e[6]||(e[6]=s=>z.value=s),persistent:""},{default:n(()=>[l(j,{style:{"min-width":"400px"}},{default:n(()=>[l(x,{class:"row items-center q-pb-none"},{default:n(()=>[e[9]||(e[9]=t("div",{class:"text-h6"},"Seleccionar Avatar",-1)),l(ea),q(l(v,{icon:"close",flat:"",round:"",dense:""},null,512),[[S]])]),_:1}),l(x,null,{default:n(()=>[e[10]||(e[10]=t("div",{class:"text-body2 q-mb-md text-grey-7"}," Elige uno de nuestros avatares predeterminados: ",-1)),t("div",ya,[(g(),k(oa,null,ra($,s=>t("div",{key:s.id,class:"col-4 text-center"},[l(D,{size:"80px",class:la(["cursor-pointer avatar-option",{"avatar-selected":m.value===s.id}]),onClick:h=>m.value=s.id},{default:n(()=>[t("img",{src:P(s.id),alt:s.nombre},null,8,_a)]),_:2},1032,["class","onClick"]),t("div",ha,ta(s.nombre),1)])),64))])]),_:1}),l(sa,{align:"right"},{default:n(()=>[q(l(v,{flat:"",label:"Cancelar",color:"grey"},null,512),[[S]]),q(l(v,{label:"Seleccionar",color:"primary",onClick:X,disable:!m.value},null,8,["disable"]),[[S]])]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}},Ca=Z(wa,[["__scopeId","data-v-9e307bd0"]]);export{Ca as default};
