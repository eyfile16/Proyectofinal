import{_ as F,y as R,a as T,r as u,s as G,W as y,X as h,B as o,A as n,Y as l,Z as S,$ as E,a0 as A,z as X,a1 as Y,C as d,a2 as Z,a3 as _,a4 as H,v as q,a5 as J,a6 as K,a7 as O,a8 as aa,a9 as ea,aa as ra,ab as oa,R as ta,S as f,U as x}from"./index-yZ2UE3Bh.js";const la={class:"row justify-center"},sa={class:"col-12 col-md-8 col-lg-6"},ia={class:"row justify-center q-mb-lg"},na={class:"column items-center"},ua=["src"],ca=["src"],da=["src"],ma={class:"q-mt-md q-gutter-sm"},va={class:"row justify-end q-mt-md"},pa={class:"row q-col-gutter-md justify-center"},ga=["src","alt"],fa={class:"text-caption q-mt-xs"},ba={__name:"Perfil",setup(ya){const i=ta(),m=R(),s=T(()=>m.usuario),v=u(""),p=u(""),z=u(""),g=u(""),P=u(""),V=u(!1),w=u(!1),c=u(""),C=u(null),U=u(!1),Q=[{id:"avatar1",nombre:"Casual"},{id:"avatar2",nombre:"Profesional"},{id:"avatar3",nombre:"Deportivo"},{id:"avatar4",nombre:"Elegante"},{id:"avatar5",nombre:"Creativo"}];G(async()=>{if(s.value){v.value=s.value.nombre||"",p.value=s.value.email||"",c.value=s.value.avatarPredeterminado||"avatar1";try{const a=await y.get(`/api/usuarios/${s.value._id}`);a.data&&(m.setUser(a.data),v.value=a.data.nombre||"",p.value=a.data.email||"",c.value=a.data.avatarPredeterminado||"avatar1")}catch(a){console.warn("No se pudieron cargar los datos actualizados del usuario:",a)}}});const b=a=>`/avatars/${a}.svg`,I=a=>a?a.startsWith("data:")||a.startsWith("http")?a:a.startsWith("/uploads/")?`http://localhost:3000${a}`:`http://localhost:3000/uploads/avatars/${a}`:null,j=a=>{var r;console.warn("Error al cargar imagen de perfil, usando avatar por defecto"),a.target.src=b(((r=s.value)==null?void 0:r.avatarPredeterminado)||"avatar1")},N=a=>{console.warn("Error al cargar avatar, usando avatar1 por defecto"),a.target.src=b("avatar1")},$=()=>{var a;c.value=((a=s.value)==null?void 0:a.avatarPredeterminado)||"avatar1",w.value=!0},B=()=>{var a;(a=C.value)==null||a.click()},D=async a=>{const r=a.target.files[0];if(r){if(!r.type.startsWith("image/")){i.notify({color:"negative",message:"Por favor selecciona un archivo de imagen válido",icon:"error"});return}if(r.size>5*1024*1024){i.notify({color:"negative",message:"La imagen debe ser menor a 5MB",icon:"error"});return}try{U.value=!0;const t=new FormData;t.append("imagen",r);const e=await y.post("/api/usuarios/subir-imagen",t,{headers:{"Content-Type":"multipart/form-data"}});if(e.data&&e.data.usuario){m.setUser(e.data.usuario);const k=I(e.data.usuario.imagenPerfil);console.log("Nueva URL de imagen:",k),i.notify({color:"positive",message:"Imagen de perfil actualizada correctamente",icon:"check"}),console.log("Imagen subida exitosamente:",e.data.usuario.imagenPerfil),setTimeout(()=>{window.location.reload()},1e3)}}catch(t){console.error("Error al subir imagen:",t),i.notify({color:"negative",message:"Error al subir la imagen",icon:"error"})}finally{U.value=!1,C.value&&(C.value.value="")}}},W=async()=>{try{const a=await y.delete("/api/usuarios/eliminar-imagen");a.data&&a.data.usuario&&(m.setUser(a.data.usuario),i.notify({color:"positive",message:"Imagen de perfil eliminada correctamente",icon:"check"}))}catch(a){console.error("Error al eliminar imagen:",a),i.notify({color:"negative",message:"Error al eliminar la imagen",icon:"error"})}},L=async()=>{if(c.value)try{const a=await y.put("/api/usuarios/avatar",{avatarPredeterminado:c.value});a.data&&a.data.usuario&&(m.setUser(a.data.usuario),w.value=!1,i.notify({color:"positive",message:"Avatar actualizado correctamente",icon:"check"}),console.log("Avatar actualizado en el backend:",a.data.usuario.avatarPredeterminado))}catch(a){console.error("Error al actualizar avatar:",a),i.notify({color:"negative",message:"Error al actualizar el avatar",icon:"error"})}},M=async()=>{try{if(V.value=!0,!v.value.trim()||!p.value.trim()){i.notify({color:"negative",message:"Por favor completa todos los campos requeridos",icon:"error"});return}const a=await y.put("/api/usuarios/actualizar",{_id:s.value._id,nombre:v.value.trim(),email:p.value.trim()});a.data&&a.data.usuario&&(m.setUser(a.data.usuario),i.notify({message:"Perfil actualizado correctamente",color:"positive",icon:"check_circle"}),console.log("Perfil actualizado en el backend:",a.data.usuario)),z.value="",g.value="",P.value=""}catch(a){console.error("Error al actualizar perfil:",a),i.notify({message:"Error al actualizar el perfil",color:"negative",icon:"error"})}finally{V.value=!1}};return(a,r)=>(f(),h("div",null,[o(H,{padding:""},{default:n(()=>[l("div",la,[l("div",sa,[o(S,{class:"q-pa-lg"},{default:n(()=>[o(E,null,{default:n(()=>{var t;return[r[7]||(r[7]=l("div",{class:"text-h5 q-mb-md"},"Mi Perfil",-1)),l("div",ia,[l("div",na,[o(A,{size:"150px",class:"q-mb-sm bg-grey-3"},{default:n(()=>{var e,k;return[(e=s.value)!=null&&e.imagenPerfil?(f(),h("img",{key:0,src:I(s.value.imagenPerfil),style:{width:"100%",height:"100%","object-fit":"cover","border-radius":"50%"},onError:j},null,40,ua)):(k=s.value)!=null&&k.avatarPredeterminado?(f(),h("img",{key:1,src:b(s.value.avatarPredeterminado),style:{width:"100%",height:"100%","object-fit":"cover"},onError:N},null,40,ca)):(f(),h("img",{key:2,src:b("avatar1"),style:{width:"100%",height:"100%","object-fit":"cover"}},null,8,da))]}),_:1}),l("div",ma,[o(d,{color:"primary",label:"Avatares",size:"md",onClick:$,icon:"face"}),o(d,{color:"secondary",label:"Subir Imagen",size:"md",onClick:B,icon:"photo_camera"}),(t=s.value)!=null&&t.imagenPerfil?(f(),X(d,{key:0,color:"negative",label:"Eliminar",size:"sm",onClick:W,icon:"delete",flat:""})):Y("",!0)]),l("input",{ref_key:"fileInput",ref:C,type:"file",accept:"image/*",style:{display:"none"},onChange:D},null,544)])]),o(Z,{onSubmit:M,class:"q-gutter-md"},{default:n(()=>[o(_,{modelValue:v.value,"onUpdate:modelValue":r[0]||(r[0]=e=>v.value=e),label:"Nombre completo",outlined:"",rules:[e=>!!e||"El nombre es obligatorio"]},null,8,["modelValue","rules"]),o(_,{modelValue:p.value,"onUpdate:modelValue":r[1]||(r[1]=e=>p.value=e),label:"Correo electrónico",outlined:"",type:"email",rules:[e=>!!e||"El correo es obligatorio",e=>/^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$/.test(e)||"Correo inválido"]},null,8,["modelValue","rules"]),r[6]||(r[6]=l("div",{class:"text-subtitle1 q-mt-lg"},"Cambiar contraseña",-1)),o(_,{modelValue:z.value,"onUpdate:modelValue":r[2]||(r[2]=e=>z.value=e),label:"Contraseña actual",outlined:"",type:"password",rules:[e=>!e||g.value.length>0&&!!e||"Requerida para cambiar contraseña"]},null,8,["modelValue","rules"]),o(_,{modelValue:g.value,"onUpdate:modelValue":r[3]||(r[3]=e=>g.value=e),label:"Nueva contraseña",outlined:"",type:"password",rules:[e=>!e||e.length>=6||"Mínimo 6 caracteres"]},null,8,["modelValue","rules"]),o(_,{modelValue:P.value,"onUpdate:modelValue":r[4]||(r[4]=e=>P.value=e),label:"Confirmar contraseña",outlined:"",type:"password",rules:[e=>!g.value.length||e===g.value||"Las contraseñas no coinciden"]},null,8,["modelValue","rules"]),l("div",va,[o(d,{type:"submit",color:"primary",label:"Guardar cambios",loading:V.value},null,8,["loading"])])]),_:1})]}),_:1})]),_:1})])])]),_:1}),o(oa,{modelValue:w.value,"onUpdate:modelValue":r[5]||(r[5]=t=>w.value=t),persistent:""},{default:n(()=>[o(S,{style:{"min-width":"400px"}},{default:n(()=>[o(E,{class:"row items-center q-pb-none"},{default:n(()=>[r[8]||(r[8]=l("div",{class:"text-h6"},"Seleccionar Avatar",-1)),o(J),q(o(d,{icon:"close",flat:"",round:"",dense:""},null,512),[[x]])]),_:1}),o(E,null,{default:n(()=>[r[9]||(r[9]=l("div",{class:"text-body2 q-mb-md text-grey-7"}," Elige uno de nuestros avatares predeterminados: ",-1)),l("div",pa,[(f(),h(K,null,O(Q,t=>l("div",{key:t.id,class:"col-4 text-center"},[o(A,{size:"80px",class:aa(["cursor-pointer avatar-option",{"avatar-selected":c.value===t.id}]),onClick:e=>c.value=t.id},{default:n(()=>[l("img",{src:b(t.id),alt:t.nombre},null,8,ga)]),_:2},1032,["class","onClick"]),l("div",fa,ea(t.nombre),1)])),64))])]),_:1}),o(ra,{align:"right"},{default:n(()=>[q(o(d,{flat:"",label:"Cancelar",color:"grey"},null,512),[[x]]),q(o(d,{label:"Seleccionar",color:"primary",onClick:L,disable:!c.value},null,8,["disable"]),[[x]])]),_:1})]),_:1})]),_:1},8,["modelValue"])]))}},_a=F(ba,[["__scopeId","data-v-48e1f3a1"]]);export{_a as default};
